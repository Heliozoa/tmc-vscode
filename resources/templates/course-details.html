<html>

<head>
    <link rel="stylesheet" type="text/css" href="{{bootstrapPath}}">
    <link rel="stylesheet" type="text/css" href="{{cssPath}}">
</head>

<body>
    

    <div class="container pt-0">
        <div class="sticky-top py-2">
            <div class="row">
                <div class="col-sm">
                    <h1>Course details</h1>
                    <h2>{{course.name}}</h2>
                    <p>{{course.description}}</p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <button class="btn-primary m-1 w-100" onclick="openCloseAll('openUncompleted')">Open all uncompleted</button>
                </div>
                <div class="col-sm-3">
                    <button class="btn-primary m-1 w-100" onclick="openCloseAll('closeCompleted')">Close all completed</button>
                </div>
                <div class="col-sm-3">
                    <button class="btn-primary m-1 w-100" onclick="downloadView( {{courseId}} )">Download more exercises</button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <button class="btn-primary m-1 w-100" onclick="handleSelected('openSelected')">Open selected</button>
                </div>
                <div class="col-sm-3">
                    <button class="btn-primary m-1 w-100" onclick="handleSelected('closeSelected')">Close selected</button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <button class="btn-secondary m-1 w-100" onclick="toggleAll()" id="togglebutton">Select all</button>
                </div>
            </div>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col"></th>
                    <th scope="col">Exercise name</th>
                    <th scope="col">Deadline</th>
                    <th scope="col">Passed</th>
                    <th scope="col">In workspace</th>
                </tr>
            </thead>
            <tbody>
            {{#each exerciseData}}
                <tr>
                    <td class="text-center"><input class="checkbox-xl" type="checkbox" value="{{this.id}}" onchange="updateCount(this)" /></td>
                    <td>{{this.name}}</td>
                    <td>{{this.deadlineString}}</td>
                    {{#if this.passed}}
                    <td><div>&#10004;</div></td>
                    {{else}}
                    <td><div>&#10060;</div></td>
                    {{/if}}
                    {{#if this.isOpen}}
                    <td><span class="badge badge-primary">open</span></td>
                    {{else}}
                    <td><span class="badge badge-secondary">closed</span></td>
                    {{/if}}
                </tr>
            {{/each}}
            </tbody>
        </table>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let selectedCount = 0;
        let totalCount = undefined;

        function handleSelected(type) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const ids = [];
            for (const checkbox of checkboxes) {
                if (checkbox.checked) {
                    ids.push(parseInt(checkbox.value));
                }
            }
            if (ids.length > 0) {
                vscode.postMessage({ type: type, ids, id: {{courseId}} });
            }
        }

        function updateCount(element) {
            selectedCount += element.checked ? 1 : -1;
            if (totalCount === undefined) {
                totalCount = document.querySelectorAll('input[type="checkbox"]').length
            }
            if (selectedCount === totalCount) {
                document.querySelector("button#togglebutton").innerHTML = "Deselect all";
            } else if (selectedCount === totalCount - 1) {
                document.querySelector("button#togglebutton").innerHTML = "Select all";
            }
        }

        function toggleAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            if (totalCount === undefined) {
                totalCount = checkboxes.length;
            }
            const deselect = selectedCount === totalCount;
            for (const checkbox of checkboxes) {
                checkbox.checked = !deselect;
            }
            if (deselect) {
                document.querySelector("button#togglebutton").innerHTML = "Select all";
                selectedCount = 0;
            } else {
                document.querySelector("button#togglebutton").innerHTML = "Deselect all";
                selectedCount = totalCount;
            }
        }

        function openCloseAll(type) {
            vscode.postMessage({ type: type, id: {{courseId}} })
        }

        function downloadView(courseId) {
            vscode.postMessage({ type: "exerciseDownloads", id: courseId })
        }

    </script>
</body>

</html>