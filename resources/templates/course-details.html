<html>

<head>
    <link rel="stylesheet" type="text/css" href="{{bootstrapPath}}">
    <link rel="stylesheet" type="text/css" href="{{cssPath}}">
</head>

<body>
    

    <div class="container pt-0">
        <div class="sticky-top py-2">
            <div class="row">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                          <li class="breadcrumb-item"><a onclick="backToMyCourses() "href="#">My courses</a></li>
                          <li class="breadcrumb-item" aria-current="page">{{course.name}}</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <h2>{{course.name}}</h2>
                    <p>{{course.description}}</p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2">
                    <button class="btn-primary m-1 w-100" onclick="downloadView( {{courseId}} )">Download exercises</button>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <h3 class="mt-2">Select</h3>
                    <div class="row">
                        <div class="col-sm-2">
                            <button class="btn-secondary m-1 w-100" onclick="toggleAll()" id="togglebutton">All</button>
                        </div>
                        <div class="col-sm-2">
                            <button class="btn-primary m-1 w-100" onclick="toggleAllPassed(false)">All uncompleted</button>
                        </div>
                        <div class="col-sm-2">
                            <button class="btn-primary m-1 w-100" onclick="toggleAllPassed(true)">All completed</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2">
                    <button class="btn-primary m-1 w-100" onclick="handleSelected('openSelected')">Open selected</button>
                </div>
                <div class="col-sm-2">
                    <button class="btn-primary m-1 w-100" onclick="handleSelected('closeSelected')">Close selected</button>
                </div>
            </div>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col"></th>
                    <th scope="col">Exercise name</th>
                    <th scope="col">Deadline</th>
                    <th scope="col">Passed</th>
                    <th scope="col">In workspace</th>
                </tr>
            </thead>
            <tbody>
            {{#each exerciseData}}
                <tr>
                    <td class="text-center">
                        {{#if this.passed}}
                        <input class="checkbox-xl" type="checkbox" data="passed" value="{{this.id}}" onchange="updateCount(this)" />
                        {{else}}
                        <input class="checkbox-xl" type="checkbox" data="unpassed" value="{{this.id}}" onchange="updateCount(this)" />
                        {{/if}}
                    </td>
                    <td>{{this.name}}</td>
                    <td>{{this.deadlineString}}</td>
                    {{#if this.passed}}
                    <td><div>&#10004;</div></td>
                    {{else}}
                    <td><div>&#10060;</div></td>
                    {{/if}}
                    {{#if this.isOpen}}
                    <td><span class="badge badge-primary" onclick="closeExercise({{this.id}})">open</span></td>
                    {{else}}
                    <td><span class="badge badge-secondary" onclick="openExercise({{this.id}})">closed</span></td>
                    {{/if}}
                </tr>
            {{/each}}
            </tbody>
        </table>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let selectedCount = 0;
        let totalCount = document.querySelectorAll('input[type="checkbox"]').length;

        function handleSelected(type) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const ids = [];
            for (const checkbox of checkboxes) {
                if (checkbox.checked) {
                    ids.push(parseInt(checkbox.value));
                }
            }
            if (ids.length > 0) {
                vscode.postMessage({ type: type, ids, id: {{courseId}} });
            }
        }

        function openExercise(id) {
            vscode.postMessage({type: 'openSelected', ids: [id], id: {{courseId}} });
        }

        function closeExercise(id) {
            vscode.postMessage({type: 'closeSelected', ids: [id], id: {{courseId}} });
        }

        function updateCount(element) {
            selectedCount += element.checked ? 1 : -1;
            if (totalCount === undefined) {
                totalCount = document.querySelectorAll('input[type="checkbox"]').length
            }

            if (selectedCount === totalCount) {
                document.querySelector("button#togglebutton").innerHTML = "None";
            } else if (selectedCount === totalCount - 1) {
                document.querySelector("button#togglebutton").innerHTML = "All";
            }
        }

        function toggleAllPassed(isPassed) {
            const selector = isPassed ? "passed" : "unpassed";
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            for (const checkbox of checkboxes) {
                if (checkbox.checked !== (checkbox.getAttribute("data") === selector)) {
                    checkbox.checked = checkbox.getAttribute("data") === selector;
                    updateCount(checkbox);
                }
            }
        }

        function toggleAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const deselect = selectedCount === totalCount;
            for (const checkbox of checkboxes) {
                checkbox.checked = !deselect;
            }
            if (deselect) {
                document.querySelector("button#togglebutton").innerHTML = "All";
                selectedCount = 0;
            } else {
                document.querySelector("button#togglebutton").innerHTML = "None";
                selectedCount = totalCount;
            }
        }

        function backToMyCourses() {
            vscode.postMessage({ type: "myCourses" });
        }

        function downloadView(courseId) {
            vscode.postMessage({ type: "exerciseDownloads", id: courseId })
        }

    </script>
</body>

</html>