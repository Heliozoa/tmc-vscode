<html>
    <head>
        {{{cspBlob}}}
        <style>
            {{{cssBlob}}}
        </style>
    </head>

    <body class="p-0">
        <div class="w-100 sticky-top">
            <div class="container pt-0">
                <div class="row">
                    <div class="col">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a onclick="backToMyCourses() " href="#">My courses</a>
                                </li>
                                <li class="breadcrumb-item" aria-current="page">
                                    {{course.title}}
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm">
                        <h2>{{course.title}}</h2>
                        <span>{{course.description}}</span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-3">
                        <button class="btn-info m-1 w-100" onclick="downloadView( {{courseId}} )">
                            Download exercises
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {{#each exerciseData}}
        <div class="container container-fluid border-dark">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md">
                    <h2>{{this.name}}</h2>
                </div>
                <div class="col-md-2">
                    <button class="btn-info">Download all (7)</button>
                </div>
                <div class="col-md-2">
                    <button class="btn-info">Open all</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md">
                    {{this.nextDeadlineString}}
                </div>
                <div class="col-md-2">
                    <button
                        class="btn-info"
                        onclick="toggleCollapse(document.getElementById('{{this.name}}-exercises'), 'block')"
                    >
                        Show all
                    </button>
                </div>
                <div class="col-md"></div>
            </div>
            <div class="row">
                <div class="col-md" id="{{this.name}}-exercises" style="display: none;">
                    <hr />
                    <table class="table table-striped table-borderless">
                        <thead>
                            <tr class="d-flex">
                                <th class="col-1 text-center" scope="col">
                                    <input
                                        class="checkbox-xl"
                                        type="checkbox"
                                        value="{{this.id}}"
                                        onchange="toggleGroup(this)"
                                    />
                                </th>
                                <th class="col-5" scope="col">Exercise</th>
                                <th class="col-4" scope="col">Deadline</th>
                                <th class="col-1" scope="col">Completed</th>
                                <th class="col-1" scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each this.exercises}}
                            <tr class="d-flex">
                                <td class="col-1 text-center">
                                    <input
                                        class="checkbox-xl"
                                        type="checkbox"
                                        data-isPassed="{{this.passed}}"
                                        value="{{this.id}}"
                                        onchange="updateCount(this)"
                                    />
                                </td>
                                <td class="col-5">{{this.name}}</td>
                                {{#if this.isHard}}
                                <td class="col-4">{{this.hardDeadlineString}}</td>
                                {{else}}
                                <td class="col-4">
                                    {{this.softDeadlineString}}
                                    <span
                                        class="font-weight-bold"
                                        title="This is a soft deadline and it can be exceeded. &#013;Exercises can be submitted after the soft deadline has passed, but you receive only 75% of the exercise points. &#013;Hard deadline for this exercise is: {{this.hardDeadlineString}}. &#013;Hard deadline can not be exceeded."
                                    >
                                        &#9432;
                                    </span>
                                </td>
                                {{/if}}
                                <td class="col-1">
                                    {{#if this.passed}} &#10004; {{else}} &#10060; {{/if}}
                                </td>
                                <td class="col-1">
                                    {{#if this.isOpen}}
                                    <span
                                        class="badge badge-primary"
                                        onclick="closeExercise({{this.id}})"
                                        >open</span
                                    >
                                    {{else}} {{#if this.isClosed}}
                                    <span
                                        class="badge badge-secondary"
                                        onclick="openExercise({{this.id}})"
                                        >closed</span
                                    >
                                    {{else}}
                                    <span class="badge badge-secondary">missing</span>
                                    {{/if}} {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <br />
        <br />
        {{/each}}
        <div
            id="contextMenu"
            class="container fixed-bottom"
            style="visibility: hidden; background-color: inherit; padding: 0;"
        >
            <div class="card border" style="background-color: inherit;">
                <div class="card-body">
                    Select action for <span id="selectedCount">0</span> selected items
                    <div class="row mt-2">
                        <div class="col-sm-3">
                            <button class="btn-info m-1 w-100" onclick="clearAll()">
                                Clear all
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const vscode = acquireVsCodeApi();
            let selectedCount = 0;

            function openExercise(id) {
                vscode.postMessage({ type: 'openSelected', ids: [id], id: {{ courseId }} });
            }

            function closeExercise(id) {
                vscode.postMessage({ type: 'closeSelected', ids: [id], id: {{ courseId }} });
            }

            function updateCount(element) {
                selectedCount += element.checked ? 1 : -1;
                refreshFooter()
            }

            function toggleGroup(element) {
                const subBoxes = element.querySelectorAll("input");
                console.log(subBoxes.length)
                for (const checkbox of subBoxes) {
                    checkbox.checked = element.checked;
                }
            }

            function toggleCollapse(element, defaultDisplay) {
                element.style.display = element.style.display === "none" ? defaultDisplay : "none";
            }

            function refreshFooter() {
                document.getElementById("selectedCount").innerText = selectedCount;
                document.getElementById("contextMenu").style.visibility = (selectedCount === 0) ? "hidden" : "visible";
            }

            function clearAll() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                for (const checkbox of checkboxes) {
                    checkbox.checked = false;
                }
                selectedCount = 0;
                refreshFooter()
            }

            function backToMyCourses() {
                vscode.postMessage({ type: "myCourses" });
            }

            function downloadView(courseId) {
                vscode.postMessage({ type: "exerciseDownloads", id: courseId })
            }
        </script>
    </body>
</html>
