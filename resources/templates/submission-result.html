<html>

<head>
    <link rel="stylesheet" type="text/css" href="{{bootstrapPath}}">
    <link rel="stylesheet" type="text/css" href="{{cssPath}}">
</head>

<body>
    <div class="container">
        <div class="row py-2">
            <div class="py-2">
                {{{submission_status statusData}}}
            </div>
        </div>
        {{#with statusData}}
            {{#if test_cases}}
                <div class="row my-1">
                    {{#if points}}
                        <h3>Points gained: {{points}}</h3>
                    {{else}}
                        <h3>Points gained: -</h3>
                    {{/if}}
                </div>
                <div class="row my-1">
                    {{{progress_bar test_cases}}}
                </div>
            {{/if}}
        {{/with}}
        {{#if feedbackQuestions}}
        <div id="feedbacknotification"></div>
        <div id="feedback" class="my-5">
            <h4>Anna palautetta</h4>
            <form>
                {{#each feedbackQuestions}}
                    <div>
                        <span>{{this.question}}</span>
                        <div class="row">
                            {{{feedback_question this}}}
                        </div>
                    </div>
                {{/each}}
                <div>
                    <button class="btn-primary" onclick="submitFeedback()">Lähetä palaute</button>
                </div>
            </form>
        </div>
        {{/if}}
        {{#with statusData}}
        <div>
            {{#each test_cases}}
            {{#if this.successful}}
            <div class="row passed my-2">
                {{else}}
                <div class="row failed my-2">
                    {{/if}}
                    <div class="col">
                        <div class="row">
                            {{#if this.successful}}
                            <div class="col-md-1 passed-header">
                                PASS:
                            </div>
                            {{else}}
                            <div class="col-md-1 failed-header">
                                FAIL:
                            </div>
                            {{/if}}
                            <div class="col-md">
                                <span>{{this.name}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <pre>{{this.message}}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>
        {{/with}}
</body>

<script>
    const vscode = acquireVsCodeApi();
    const feedback_url = "{{statusData.feedback_answer_url}}";
    const solution_url = "{{statusData.solution_url}}";

    const feedbackNotification = document.getElementById("feedbacknotification");
    const feedbackFormContainer = document.getElementById("feedback");

    function submitFeedback() {
        const feedback = [];
        const sliders = document.querySelectorAll("input[type=range]");
        for (slider of sliders) {
            if (slider.value !== slider.min) {
                feedback.push({ question_id: parseInt(slider.dataset.questionid, 10), answer: slider.value })
            }
        }
        const textareas = document.querySelectorAll("textarea");
        for (textarea of textareas) {
            if (textarea.value !== "") {
                feedback.push({ question_id: parseInt(textarea.dataset.questionid, 10), answer: textarea.value })
            }
        }

        feedbackFormContainer.style.display = "none";
        feedbackNotification.classList = "my-5 alert alert-success";
        if (feedback.length > 0) {
            feedbackNotification.innerText = "Feedback sent! Thank you.";
        } else {
            feedbackNotification.innerText = "No feedback given.";
        }
        vscode.postMessage({ feedback: { status: feedback }, url: feedback_url });
    }

    function showValue(slider, id) {
        document.getElementById(id).innerHTML = slider.value === slider.min ? "-" : slider.value;
    }

    function viewModelSolution() {
        vscode.postMessage({ showSolutionInBrowser: true, solutionUrl: solution_url });
    }

</script>

</html>
